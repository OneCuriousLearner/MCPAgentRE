# 历史需求知识库使用指南

## 📋 概述

历史需求知识库是一个智能化的需求管理系统，用于存储和管理历史需求及功能变化，为编写新测试用例提供参考和关联。

## 🚀 快速开始

### 1. 环境准备

确保您已经完成项目的基础环境配置：

```bash
# 切换到项目目录
cd D:\Workplace\PYWorkplace\MCPAgentRE

# 安装依赖
uv sync

# 验证MCP服务器是否正常
uv run check_mcp_tools.py
```

### 2. 第一次使用

#### 步骤1：获取TAPD数据
```bash
# 获取最新的TAPD数据
uv run tapd_data_fetcher.py
```

#### 步骤2：构建知识库
```bash
# 运行知识库测试脚本，自动构建知识库
uv run test/test_knowledge_base_simple.py
```

#### 步骤3：验证功能
测试脚本会自动执行以下操作：
- 创建知识库基础结构
- 添加示例需求数据
- 测试搜索和推荐功能
- 显示统计信息

## 🛠️ 通过AI客户端使用

### 1. 启动MCP服务器

MCP服务器会自动启动，您可以通过AI客户端（如Claude Desktop）访问以下工具：

### 2. 核心功能说明

#### 📚 构建知识库
```
工具名称: build_requirement_knowledge_base
参数: 
  - data_file_path: TAPD数据文件路径（默认：local_data/msg_from_fetcher.json）

用法示例:
"请使用build_requirement_knowledge_base工具从TAPD数据构建历史需求知识库"
```

#### ➕ 添加需求到知识库
```
工具名称: add_requirement_to_knowledge_base
参数:
  - req_id: 需求ID（必填）
  - title: 需求标题（必填）
  - description: 需求描述（必填）
  - feature_type: 功能类型（必填）
  - complexity: 复杂度（默认：中等）
  - business_scenario: 业务场景JSON数组（默认：[]）
  - technical_keywords: 技术关键词JSON数组（默认：[]）
  - test_case_templates: 测试用例模板JSON数组（默认：[]）

用法示例:
"请添加一个新需求到知识库：
- 需求ID: REQ_LOGIN_001
- 标题: 用户登录功能
- 描述: 支持手机号和邮箱登录，包含密码强度验证
- 功能类型: 认证授权
- 业务场景: [\"用户管理\", \"安全验证\"]
- 技术关键词: [\"登录\", \"验证\", \"Token\"]"
```

#### 🔍 搜索相似需求
```
工具名称: search_similar_requirements
参数:
  - query: 搜索查询（必填）
  - feature_type: 功能类型过滤（可选）
  - top_k: 返回结果数量（默认：5）

用法示例:
"请搜索与'用户登录验证'相关的历史需求"
"请在'认证授权'类型中搜索'密码重置'相关的需求"
```

#### 🎯 推荐测试用例
```
工具名称: recommend_test_cases_for_requirement
参数:
  - req_id: 需求ID（可选）
  - title: 需求标题（必填）
  - description: 需求描述（必填）
  - feature_type: 功能类型（必填）
  - business_scenario: 业务场景JSON数组（默认：[]）
  - technical_keywords: 技术关键词JSON数组（默认：[]）
  - use_ai: 是否使用AI推荐（默认：true）

用法示例:
"请为以下需求推荐测试用例：
- 标题: 密码重置功能
- 描述: 用户忘记密码时可以通过邮箱重置
- 功能类型: 认证授权
- 业务场景: [\"用户管理\"]
- 技术关键词: [\"密码\", \"重置\", \"邮箱\"]"
```

#### 📊 分析测试覆盖度
```
工具名称: analyze_requirement_test_coverage
参数:
  - requirement_id: 需求ID（必填）

用法示例:
"请分析需求REQ_LOGIN_001的测试覆盖度"
```

#### 📈 获取知识库统计
```
工具名称: get_knowledge_base_stats

用法示例:
"请显示知识库的统计信息"
```

## 🎯 实际使用场景

### 场景1：新功能测试用例设计
```
1. 产品经理提出新需求："支持微信登录"
2. 使用搜索功能：search_similar_requirements("微信登录")
3. 查看相似的第三方登录需求
4. 使用推荐功能：recommend_test_cases_for_requirement(...)
5. 基于推荐结果编写测试用例
```

### 场景2：测试用例完整性检查
```
1. 选择一个已有需求
2. 使用覆盖度分析：analyze_requirement_test_coverage("REQ_XXX")
3. 查看缺失的测试类型
4. 补充相应的测试用例
```

### 场景3：团队知识沉淀
```
1. 定期将新需求添加到知识库
2. 关联相应的测试用例模板
3. 建立需求演化路径
4. 为新团队成员提供历史参考
```

## 📁 数据存储结构

知识库数据存储在以下文件中：

```
local_data/
├── requirement_knowledge_base.json    # 主知识库文件
├── feature_evolution_map.json         # 功能演化图谱
├── test_case_templates.json           # 测试用例模板库
└── kb_vector_data/                     # 向量数据库（未来功能）
```

## 🔧 高级配置

### 1. AI推荐配置
如需使用AI推荐功能，请配置DeepSeek API：

```bash
# Windows PowerShell
$env:DS_KEY = "your-deepseek-api-key"

# 或永久设置
[Environment]::SetEnvironmentVariable("DS_KEY", "your-deepseek-api-key", "User")
```

### 2. 自定义模板
可以手动编辑 `test_case_templates.json` 添加自定义测试用例模板：

```json
{
  "templates": [
    {
      "name": "登录功能模板",
      "applicable_features": ["认证授权"],
      "scenario": "用户登录验证",
      "steps_template": ["打开登录页面", "输入凭证", "点击登录"],
      "expected_template": "成功登录"
    }
  ]
}
```

## 🚨 常见问题

### Q1: 知识库构建失败
**问题**：提示"数据文件不存在"
**解决**：
1. 确保已运行 `uv run tapd_data_fetcher.py` 获取数据
2. 检查 `local_data/msg_from_fetcher.json` 文件是否存在
3. 确认TAPD API配置正确

### Q2: 搜索结果为空
**问题**：搜索相似需求返回空结果
**解决**：
1. 确保知识库中已有相关需求数据
2. 尝试使用更通用的搜索关键词
3. 检查功能类型过滤是否过于严格

### Q3: AI推荐不工作
**问题**：推荐功能返回错误
**解决**：
1. 检查DS_KEY环境变量是否正确设置
2. 确认网络连接正常
3. 可以设置use_ai=false使用基于规则的推荐

### Q4: 编码问题
**问题**：中文显示乱码
**解决**：
1. 确保终端支持UTF-8编码
2. 在Windows上使用PowerShell而非CMD
3. 检查系统区域设置

## 🔍 测试和验证

### 运行完整测试
```bash
# 运行基础功能测试
uv run test/test_knowledge_base_simple.py

# 运行完整功能测试（包含emoji，需要UTF-8支持）
uv run test/test_knowledge_base.py
```

### 验证MCP工具注册
```bash
# 检查所有MCP工具是否正确注册
uv run check_mcp_tools.py
```

## 📞 获取帮助

如遇到问题，请：
1. 查看上述常见问题部分
2. 检查 `local_data/` 目录下的日志文件
3. 运行测试脚本验证基础功能
4. 确认MCP服务器正常运行

## 🎉 下一步

知识库系统已经可以使用，建议：
1. 先运行测试脚本熟悉功能
2. 通过AI客户端体验实际使用
3. 根据团队需求添加更多历史需求数据
4. 定期更新和维护知识库内容

---

*本指南涵盖了历史需求知识库的完整使用方法，如有疑问请参考项目文档或运行测试脚本。*